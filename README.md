# stbweb
>自己的web框架，封装各个模块，api拦截，异步端口监听，多个httpserver同时服务，后台日志收集服务等

## 1.api拦截实现
>功能核心，采用类多态的性质，引入工作元素的概念，每一个工作元素将对应不同的业务类，实现功能划分。权限上将api分为内部调用和外部调用，来约束调用过程
将每个对应功能都分配一个业务类，对应业务类实现get，post方法，在init的时候，将所有业务类注册到对应全局注册中心，等待，将拦截到的请求，与全局注册中的类匹配成功后，指向该类的方法内部执行。
在进行拦截时，获取到所有url请求，进行url处理，获取到标识，对应到相应的工作元素。这里将保存request和ResponseWriter，工作元素信息，用户信息等。然后，获取控制器的标识与全局注册中心匹配，成功后将进入api调用，否之，则无效请求。

## 2.用户管理模块
>用户操作通过redis进行状态保存。注册将用户信息保存至数据库中，期间，将获取部分用户信息，结合加密算法生成唯一salt,使用md5结合salt生成password密文,采用二进制存储。登录时，使用相同加密方式进行验证，即使代码加密方式泄密，第三方也无法获取唯一salt，保证密码的安全性。登录后，将用户信息注册如redis用户组，同时保存用户状态，反馈api请求token。
## 3.日志收集模块
>使用了第三方logrus包，将信息输出分成多个收集，定向不同的文件句柄中。logrus中将定义一个每日log文件，记录基本的信息。而系统中的日记分两种，一个panic的异常信息，另一个为普通日志信息，这里调用了系统的dll方式，不同操作系统使用不用的编译文件，将panic的错误信息重定向至指定文件内，防止控制台因为行数的约束未能记录获取信息。
## 4.聊天室及消息传递模块
>聊天室以及消息功能，是以基于websocket为基础，使用改进了聊天室的框架搭建的。每个连接使用Sec-WebSocket-Protocol标记用户，也可以在发送的信息内标记用户。  
## 5.任务处理以及过程结果记录
>将任务定义为一个单独的对象，内部包含任务基本信息以及待处理逻辑。内部调用了cron和ants两个包结合使用，达到了定时功能和线程池化的处理，同时，在处理过程中，使用redis记录执行过程，并执行后记录至数据库中。  
  
## 项目架构
#### --builds\common  
    main.go 主函数入口  
    assets静态资源存放  
    log logrus每日日志记录  
    config 配置文件  
    err.txt panic定向文件  
    log.txt普通日志收集文件  
#### --core  
    核心功能模块，定义了主要的功能内容和全局引用  
#### --lib  
    功能列表，单独分开独立的功能工具  
    现有功能：  
    1.聊天室（基于websocket实现）  
    2.登录，注册  
    3.提取图片文字（基于baiduAPI实现）  
#### --loader  
    启动服务设定  
#### --modules  
    实际业务实现模块  
## sql及nosql  
    后天数据库使用了mysql,缓存使用redis。内部实现重连机制，失败后5s后进行重新连接。  